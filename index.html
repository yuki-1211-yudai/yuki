<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ¤œç´¢ãƒ©ãƒ³ãƒãƒ£ãƒ¼ï¼ˆPWAå¯¾å¿œï¼‰</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b69ff">
  <style>
    :root { --bg: #fafafa; --card: #fff; --muted: #666; --accent: #0b69ff; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; background: var(--bg); margin:0; padding:20px; display:flex; justify-content:center; }
    .container { max-width:820px; width:100%; background:var(--card); padding:20px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    h2 { margin:0 0 12px 0; font-size:1.25rem; display:flex; gap:8px; align-items:center; }
    .controls { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center; }
    input[type="text"] { flex:1 1 320px; padding:10px 12px; font-size:16px; border:1px solid #ddd; border-radius:8px; }
    select { padding:8px 10px; border-radius:8px; border:1px solid #ddd; }
    button { padding:10px 12px; border-radius:8px; border: none; background:var(--accent); color:#fff; cursor:pointer; font-size:14px; }
    button.secondary { background:#eee; color:#222; }
    .history { margin-top:18px; text-align:left; }
    .history-list { list-style:none; padding:0; margin:0; max-height:300px; overflow:auto; border:1px solid #eee; border-radius:8px; background:#fafafa; }
    .history-item { display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid #f1f1f1; }
    .history-item:last-child { border-bottom: none; }
    .query { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px; color:#111; }
    .meta { color:var(--muted); font-size:12px; min-width:140px; text-align:right; }
    .icon-btn { background:transparent; border:none; cursor:pointer; padding:6px; border-radius:6px; }
    .small { font-size:13px; padding:8px 10px; border-radius:8px; }
    .footer { margin-top:12px; display:flex; gap:8px; justify-content:flex-end; align-items:center; }
    .hint { color:var(--muted); font-size:13px; }
    @media (max-width:520px){ .meta { display:none; } .controls { flex-direction:column; align-items:stretch; } button { width:100%; } }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="æ¤œç´¢ãƒ©ãƒ³ãƒãƒ£ãƒ¼">
    <h2>ğŸ” è‡ªå‹•ä¿å­˜ã¤ãæ¤œç´¢ãƒ©ãƒ³ãƒãƒ£ãƒ¼ï¼ˆPWAå¯¾å¿œï¼‰</h2>

    <div class="controls">
      <input id="query" type="text" placeholder="æ¤œç´¢èªã‚’å…¥åŠ›ã—ã¦ Enter ã¾ãŸã¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„" aria-label="æ¤œç´¢èªå…¥åŠ›">
      <select id="engine" aria-label="æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠ" title="æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³">
        <option value="https://www.google.com/search?q=">Google</option>
        <option value="https://duckduckgo.com/?q=">DuckDuckGo</option>
        <option value="https://www.bing.com/search?q=">Bing</option>
      </select>
      <button id="searchBtn" class="small">æ¤œç´¢</button>
      <button id="showHideBtn" class="secondary small">å±¥æ­´ã‚’è¡¨ç¤º</button>
    </div>

    <div class="history" id="historyArea" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="hint">å±¥æ­´ï¼ˆæœ€æ–°ãŒä¸Šï¼‰</div>
        <div>
          <button id="exportBtn" class="secondary small">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <label for="importFile" style="display:inline-block">
            <input id="importFile" type="file" accept="application/json" style="display:none">
            <button class="secondary small">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          </label>
          <button id="clearAllBtn" class="secondary small">å…¨æ¶ˆå»</button>
        </div>
      </div>

      <ul id="historyList" class="history-list" aria-live="polite"></ul>
    </div>

    <div class="footer">
      <div class="hint">ä¿å­˜å½¢å¼: localStorage (searchLog) â€” JSONé…åˆ—ã€ä¸Šé™200ä»¶</div>
    </div>
  </div>

<script>
(function(){
  // PWA: service worker ç™»éŒ²
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(e => console.warn('SWç™»éŒ²å¤±æ•—', e));
  }

  const KEY = 'searchLog';
  const MAX_ENTRIES = 200;

  const qInput = document.getElementById('query');
  const engineSelect = document.getElementById('engine');
  const searchBtn = document.getElementById('searchBtn');
  const showHideBtn = document.getElementById('showHideBtn');
  const historyArea = document.getElementById('historyArea');
  const historyList = document.getElementById('historyList');
  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');
  const clearAllBtn = document.getElementById('clearAllBtn');

  function loadLogs(){
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed;
    } catch(e){ console.warn('èª­ã¿è¾¼ã¿å¤±æ•—', e); return []; }
  }

  function saveLogs(arr){
    try {
      localStorage.setItem(KEY, JSON.stringify(arr));
    } catch(e){ console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼', e); alert('å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  }

  function addLog(query){
    if(!query) return;
    const logs = loadLogs();
    const now = new Date().toISOString();
    if (logs.length && logs[0].q === query) return;
    logs.unshift({ q: query, ts: now });
    if (logs.length > MAX_ENTRIES) logs.splice(MAX_ENTRIES);
    saveLogs(logs);
    renderLogs();
  }

  function removeLogAt(index){
    const logs = loadLogs();
    if (index < 0 || index >= logs.length) return;
    logs.splice(index,1);
    saveLogs(logs);
    renderLogs();
  }

  function clearAll(){
    if (!confirm('å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
    localStorage.removeItem(KEY);
    renderLogs();
  }

  function renderLogs(){
    const logs = loadLogs();
    historyList.innerHTML = '';
    if (!logs.length) {
      historyList.innerHTML = '<li class="history-item"><div class="query" style="color:#666">(ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“)</div></li>';
      return;
    }
    logs.forEach((item, idx) => {
      const li = document.createElement('li');
      li.className = 'history-item';
      const qdiv = document.createElement('div');
      qdiv.className = 'query';
      qdiv.title = item.q;
      qdiv.textContent = item.q;
      qdiv.style.cursor = 'pointer';
      qdiv.addEventListener('click', () => {
        qInput.value = item.q;
        doSearch(item.q);
      });

      const meta = document.createElement('div');
      meta.className = 'meta';
      const d = new Date(item.ts);
      meta.textContent = d.toLocaleString();

      const btns = document.createElement('div');
      btns.style.display = 'flex';
      btns.style.gap = '6px';

      const copyBtn = document.createElement('button');
      copyBtn.className = 'icon-btn';
      copyBtn.title = 'å…¥åŠ›æ¬„ã«ã‚³ãƒ”ãƒ¼';
      copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼';
      copyBtn.addEventListener('click', () => { qInput.value = item.q; qInput.focus(); });

      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.title = 'ã“ã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤';
      delBtn.textContent = 'å‰Šé™¤';
      delBtn.addEventListener('click', () => {
        if (confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) removeLogAt(idx);
      });

      btns.appendChild(copyBtn);
      btns.appendChild(delBtn);

      li.appendChild(qdiv);
      li.appendChild(meta);
      li.appendChild(btns);
      historyList.appendChild(li);
    });
  }

  function openInNewTab(url){
    const w = window.open('', '_blank');
    if (!w) { alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚Šæ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'); return; }
    try { w.opener = null; w.location = url; } catch(e) { window.open(url, '_blank'); }
  }

  function doSearch(q){
    if (!q) return;
    const base = engineSelect.value || 'https://www.google.com/search?q=';
    const url = base + encodeURIComponent(q);
    addLog(q);
    openInNewTab(url);
    qInput.value = '';
  }

  searchBtn.addEventListener('click', () => doSearch(qInput.value.trim()));
  qInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); doSearch(qInput.value.trim()); }
  });

  showHideBtn.addEventListener('click', () => {
    if (historyArea.style.display === 'none') {
      historyArea.style.display = 'block';
      showHideBtn.textContent = 'å±¥æ­´ã‚’éš ã™';
      renderLogs();
    } else {
      historyArea.style.display = 'none';
      showHideBtn.textContent = 'å±¥æ­´ã‚’è¡¨ç¤º';
    }
  });

  exportBtn.addEventListener('click', () => {
    const logs = loadLogs();
    const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'search-history.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  importFile.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    if (!confirm('é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å±¥æ­´ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ—¢å­˜ã®å±¥æ­´ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) { e.target.value = ''; return; }
    const fr = new FileReader();
    fr.onload = () => {
      try {
        const imported = JSON.parse(fr.result);
        if (!Array.isArray(imported)) throw new Error('ä¸æ­£ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ');
        const current = loadLogs();
        const merged = [...imported, ...current];
        const normalized = merged.map(it => {
          if (typeof it === 'string') return { q: it, ts: new Date().toISOString() };
          return { q: String(it.q || ''), ts: it.ts || new Date().toISOString() };
        }).filter(it => it.q);
        const seen = new Set();
        const unique = [];
        for (const it of normalized) {
          if (!seen.has(it.q)) { seen.add(it.q); unique.push(it); }
        }
        if (unique.length > MAX_ENTRIES) unique.splice(MAX_ENTRIES);
        saveLogs(unique);
        renderLogs();
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
      } catch(err) {
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      } finally {
        e.target.value = '';
      }
    };
    fr.readAsText(f, 'utf-8');
  });

  clearAllBtn.addEventListener('click', clearAll);

  renderLogs();
  qInput.focus();
})();
</script>
</body>
</html>